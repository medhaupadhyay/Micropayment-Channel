<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Transfer Interface</title>
    <!-- <link rel="stylesheet" href="styles.css"> -->
</head>

<body>
    <div class="container">
        <h2>Ethereum Transfer</h2>


        <!-- Login With MetaMask-->
        <!-- Completed - Minh-->
        <h3>Log In</h3>

        <button id="loginButton">MetaMask Login</button>
        <p id="errorMessage" style="color: rgb(208, 21, 0); display: none;"></p>
        <script>

            document.addEventListener("DOMContentLoaded", function () {
                const loginButton = document.getElementById("loginButton");
                const errorMessage = document.getElementById("errorMessage");

                loginButton.addEventListener("click", async function () {
                    if (window.ethereum) {
                        try {
                            // Check if MetaMask is installed and the user is logged in
                            if (window.ethereum.selectedAddress) {
                                errorMessage.innerText = "You are already logged in with MetaMask.";
                                errorMessage.style.display = "block";
                                // You can perform further actions here if the user is already logged in
                            } else {
                                // Request account access if needed
                                // await window.ethereum.request({ method: "eth_requestAccounts" });
                                alert("MetaMask account already connected.");
                                // You can perform further actions after successful login here
                            }
                        } catch (error) {
                            errorMessage.innerText = "Error connecting MetaMask account: " + error.message;
                            errorMessage.style.display = "block";
                            console.error("Error connecting MetaMask account:", error);
                        }
                    } else {
                        alert("MetaMask extension not detected.");
                        // errorMessage.innerText = "MetaMask extension not detected";
                        // errorMessage.style.display = "block";
                        console.error("MetaMask extension not detected");
                    }
                });
            });

        </script>


        <!-- Deploy New Channel -->
        <!-- THIS NEEDS TO BE IMPLEMENTED-->


        <h3>Create New Channel</h3>
        <p>To open a payment channel with a new receiver, fill out the fields below. If you already have a channel with
            this receiver, go to "Log Payments on an Existing Channel" and enter the Contract address for that existing
            channel.</p>

        <!-- <label for="sender">Sender Wallet Address:</label>
        <input type="text" id="sender" required> -->

        <label for="receiver">Receiver Wallet Address:</label>
        <input type="text" id="receiver" required>
        <div>
            <label for="deploymentAmount">Deployment Amount (initial amount that will be stored in the payment channel
                as
                soon as it is opened):</label>
            <input type="text" id="deploymentAmount" required>
        </div>
        <label for="expirationTime">Expiration Time (if the amount of time specified passes and the receiver does not
            cash out their payments, the Ethereum will be returned to the sender):</label>
        <input type="text" id="expirationTime" required>


        <button id="saveButton">Save Addresses</button>

        <script src="https://cdn.jsdelivr.net/npm/web3@1.3.5/dist/web3.min.js"></script>
        <!-- Getting address input and save it to use with the contract Minh-->
        <!-- Right now I can save the input -->
        <!-- Need to work on how to put it into the contract -->
        <script>
            const web3 = new Web3(window.ethereum);

            let accounts;
            ethereum.request({ method: 'eth_requestAccounts' })
                .then(_accounts => {
                    accounts = _accounts;
                })
                .catch(error => {
                    console.error('Error:', error);
                });

            document.addEventListener("DOMContentLoaded", function () {
                const saveButton = document.getElementById("saveButton");
                const receiverInput = document.getElementById("receiver");
                let receiverAddress;
                let senderAddress;

                saveButton.addEventListener("click", function () {
                    receiverAddress = receiverInput.value;
                    senderAddress = accounts[0];
                    alert("Sender Address saved: " + senderAddress + "\nReceiver Address saved: " + receiverAddress);
                    console.log("Sender Address saved:", senderAddress);
                    console.log("Receiver Address saved:", receiverAddress);
                });

            });

        </script>




        <!-- ///////////////////////////////////// -->
        <p> After deploying the contract, please store the contract address. You will need to enter this address below
            to log future payments.</p>

        <button id="deployContractButton">Deploy Contract</button>
        <!-- Deploy contract function -->
        <!-- Work in progress Minh -->
        <!-- Replace the ABI and ByteCode -->
        <script src="https://cdn.jsdelivr.net/npm/web3@1.3.5/dist/web3.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const deployButton = document.getElementById("deployContractButton");

                deployButton.addEventListener("click", async function () {
                    if (window.ethereum) {
                        try {
                            // Connect to MetaMask
                            const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                            const account = accounts[0];

                            // Create a new instance of web3 with MetaMask
                            const web3 = new Web3(window.ethereum);

                            // Define Solidity contract ABI (from Remix compiled contract)
                            const contractABI = [
                                // Put in our Solidity Contract's ABI here in the []
                                [
                                    {
                                        "inputs": [
                                            {
                                                "internalType": "address payable",
                                                "name": "recipientAddress",
                                                "type": "address"
                                            },
                                            {
                                                "internalType": "uint256",
                                                "name": "duration",
                                                "type": "uint256"
                                            }
                                        ],
                                        "stateMutability": "payable",
                                        "type": "constructor"
                                    },
                                    {
                                        "inputs": [],
                                        "name": "claimTimeout",
                                        "outputs": [],
                                        "stateMutability": "nonpayable",
                                        "type": "function"
                                    },
                                    {
                                        "inputs": [
                                            {
                                                "internalType": "uint256",
                                                "name": "amount",
                                                "type": "uint256"
                                            },
                                            {
                                                "internalType": "bytes",
                                                "name": "signature",
                                                "type": "bytes"
                                            }
                                        ],
                                        "name": "close",
                                        "outputs": [],
                                        "stateMutability": "nonpayable",
                                        "type": "function"
                                    },
                                    {
                                        "inputs": [],
                                        "name": "expiration",
                                        "outputs": [
                                            {
                                                "internalType": "uint256",
                                                "name": "",
                                                "type": "uint256"
                                            }
                                        ],
                                        "stateMutability": "view",
                                        "type": "function"
                                    },
                                    {
                                        "inputs": [
                                            {
                                                "internalType": "uint256",
                                                "name": "newExpiration",
                                                "type": "uint256"
                                            }
                                        ],
                                        "name": "extend",
                                        "outputs": [],
                                        "stateMutability": "nonpayable",
                                        "type": "function"
                                    },
                                    {
                                        "inputs": [],
                                        "name": "recipient",
                                        "outputs": [
                                            {
                                                "internalType": "address payable",
                                                "name": "",
                                                "type": "address"
                                            }
                                        ],
                                        "stateMutability": "view",
                                        "type": "function"
                                    },
                                    {
                                        "inputs": [],
                                        "name": "sender",
                                        "outputs": [
                                            {
                                                "internalType": "address payable",
                                                "name": "",
                                                "type": "address"
                                            }
                                        ],
                                        "stateMutability": "view",
                                        "type": "function"
                                    }
                                ]
                            ];

                            // Put in Solidity contract bytecode (from Remix compiled contract)
                            const contractBytecode = "608060405260405162000b8138038062000b81833981810160405281019062000029919062000161565b335f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508160015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508042620000b69190620001d3565b60028190555050506200020d565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f620000f382620000c8565b9050919050565b6200010581620000e7565b811462000110575f80fd5b50565b5f815190506200012381620000fa565b92915050565b5f819050919050565b6200013d8162000129565b811462000148575f80fd5b50565b5f815190506200015b8162000132565b92915050565b5f80604083850312156200017a5762000179620000c4565b5b5f620001898582860162000113565b92505060206200019c858286016200014b565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f620001df8262000129565b9150620001ec8362000129565b9250828201905080821115620002075762000206620001a6565b5b92915050565b610966806200021b5f395ff3fe608060405234801561000f575f80fd5b5060043610610060575f3560e01c80630e1da6c314610064578063415ffba71461006e5780634665096d1461008a57806366d003ac146100a857806367e404ce146100c65780639714378c146100e4575b5f80fd5b61006c610100565b005b61008860048036038101906100839190610640565b610173565b005b6100926102a9565b60405161009f91906106a9565b60405180910390f35b6100b06102af565b6040516100bd9190610701565b60405180910390f35b6100ce6102d4565b6040516100db9190610701565b60405180910390f35b6100fe60048036038101906100f9919061071a565b6102f7565b005b60025442101561010e575f80fd5b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc4790811502906040515f60405180830381858888f19350505050158015610170573d5f803e3d5ffd5b50565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101cb575f80fd5b6101d58282610364565b6101dd575f80fd5b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc8390811502906040515f60405180830381858888f19350505050158015610241573d5f803e3d5ffd5b505f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc4790811502906040515f60405180830381858888f193505050501580156102a4573d5f803e3d5ffd5b505050565b60025481565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461034d575f80fd5b600254811161035a575f80fd5b8060028190555050565b5f80610397308560405160200161037c9291906107f6565b604051602081830303815290604052805190602001206103f9565b90505f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166103d98285610428565b73ffffffffffffffffffffffffffffffffffffffff161491505092915050565b5f8160405160200161040b919061089e565b604051602081830303815290604052805190602001209050919050565b5f805f8061043585610492565b9250925092506001868484846040515f815260200160405260405161045d94939291906108ed565b6020604051602081039080840390855afa15801561047d573d5f803e3d5ffd5b50505060206040510351935050505092915050565b5f805f60418451146104a2575f80fd5b602084015191506040840151905060608401515f1a92509193909250565b5f604051905090565b5f80fd5b5f80fd5b5f819050919050565b6104e3816104d1565b81146104ed575f80fd5b50565b5f813590506104fe816104da565b92915050565b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6105528261050c565b810181811067ffffffffffffffff821117156105715761057061051c565b5b80604052505050565b5f6105836104c0565b905061058f8282610549565b919050565b5f67ffffffffffffffff8211156105ae576105ad61051c565b5b6105b78261050c565b9050602081019050919050565b828183375f83830152505050565b5f6105e46105df84610594565b61057a565b905082815260208101848484011115610600576105ff610508565b5b61060b8482856105c4565b509392505050565b5f82601f83011261062757610626610504565b5b81356106378482602086016105d2565b91505092915050565b5f8060408385031215610656576106556104c9565b5b5f610663858286016104f0565b925050602083013567ffffffffffffffff811115610684576106836104cd565b5b61069085828601610613565b9150509250929050565b6106a3816104d1565b82525050565b5f6020820190506106bc5f83018461069a565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6106eb826106c2565b9050919050565b6106fb816106e1565b82525050565b5f6020820190506107145f8301846106f2565b92915050565b5f6020828403121561072f5761072e6104c9565b5b5f61073c848285016104f0565b91505092915050565b5f819050919050565b5f61076861076361075e846106c2565b610745565b6106c2565b9050919050565b5f6107798261074e565b9050919050565b5f61078a8261076f565b9050919050565b5f8160601b9050919050565b5f6107a782610791565b9050919050565b5f6107b88261079d565b9050919050565b6107d06107cb82610780565b6107ae565b82525050565b5f819050919050565b6107f06107eb826104d1565b6107d6565b82525050565b5f61080182856107bf565b60148201915061081182846107df565b6020820191508190509392505050565b5f81905092915050565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000005f82015250565b5f61085f601c83610821565b915061086a8261082b565b601c82019050919050565b5f819050919050565b5f819050919050565b61089861089382610875565b61087e565b82525050565b5f6108a882610853565b91506108b48284610887565b60208201915081905092915050565b6108cc81610875565b82525050565b5f60ff82169050919050565b6108e7816108d2565b82525050565b5f6080820190506109005f8301876108c3565b61090d60208301866108de565b61091a60408301856108c3565b61092760608301846108c3565b9594505050505056fea26469706673582212203fa108247f6f8e71f528ede8a87f6ace7745424ec29e5cb6690a1074a30a4dc764736f6c63430008180033"; // Your contract's bytecode goes here

                            // Create a new contract instance
                            const contract = new web3.eth.Contract(contractABI);
                            // Deploy the contract
                            const deployedContract = await contract.deploy({
                                data: '0x0' + contractBytecode
                            }).send({
                                gas: "1000000", gasPrice: "5000000000", from: accounts[0]
                            });

                            console.log("Contract deployed at address:", deployedContract.options.address);
                            alert("Contract deployed at address: " + deployedContract.options.address);
                        } catch (error) {
                            console.error("Error deploying contract:", error);
                            alert("Error deploying contract: " + error.message);
                        }
                    } else {
                        console.error("MetaMask extension not detected");
                        alert("MetaMask extension not detected");
                    }
                });
            });
        </script>



        <!-- Log a New Channel-->
        <!-- completed - Medha :) -->
        <h3>Log a New Channel</h3>
        <p> Enter the details of your newly created payment channel.</p>

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Getting User Input</title>
        </head>

        <body>
            <form onsubmit="return createNew()">
                <label for="newAddress">New Contract Address:</label>
                <input type="text" id="newAddress" required>

                <button type="submit">Submit</button>
            </form>

            <script>
                function createNew() {
                    let newAddress = document.getElementById("newAddress").value;
                    addressStatus = "ok"
                    for (var key in localStorage) {
                        //console.log(key)
                        if (key == newAddress) { addressStatus = "stop" }
                    }
                    console.log(addressStatus);
                    if (addressStatus == "ok") {
                        localStorage.setItem(newAddress, 0);
                        alert("New channel has been logged with the following address: " + newAddress);
                    }
                    else { alert("Channel " + newAddress + " is already logged. Please proceed to logging a payment on an existing channel.") }

                    return false;
                }
            </script>
        </body>


        <!-- Log Payments on Existing Channel -->
        <!-- needs signature integration! - Medha :) -->
        <h3>Log Payments on Existing Channel</h3>

        <p> Please keep in mind that logging a payment is <i>not</i> equivalent to making an Ethereum transfer. The
            receiver will not receive any funds until the payment channel is closed, at which point the transfer will be
            made. </p>

</body>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting User Input</title>
</head>

<body>

    <label for="name">Contract Address:</label>
    <input type="text" id="name" required>

    <label for="score">Amount (ETH):</label>
    <input type="text" id="score" required>

    <button id="submit">Log Payment</button>


    <script>
        function constructPaymentMessage(contractAddress, amount) {
            return web3.utils.soliditySha3(
                { type: 'address', value: contractAddress },
                { type: 'uint256', value: amount },
            );
        }

        function signMessage(message, callback) {
            web3.eth.personal.sign(message, accounts[0], callback);
        }

        function signPayment(contractAddress, amount, callback) {
            var message = constructPaymentMessage(contractAddress, amount);
            signMessage(message, callback);
        }

        document.addEventListener("DOMContentLoaded", function () {
            const submit = document.getElementById("submit");
            let contractAddress;
            let amount;
            let signedSignature;
            let paymentMessage;

            submit.addEventListener("click", function () {
                contractAddress = document.getElementById("name").value;
                amount = document.getElementById("score").value;
                paymentMessage = constructPaymentMessage(contractAddress, amount);

                signPayment(
                    contractAddress,
                    amount,
                    function(error, signature) {
                        console.log("Contract: ", contractAddress);

                        if (error) {
                            console.error(error);
                        } else {
                            signedSignature = signature;
                            console.log("Signature: ", signature);
                        }
                    }
                );
                
                // need to figure out
                alert("Please copy the following message & signature and securely send them to the receiver\n. \
                Message:\n" + paymentMessage + "\nSignature:\n" + signedSignature);
                
                // ask about this
                // let userName = document.getElementById("name").value;
                // let userScore = parseFloat(document.getElementById("score").value);

                // const current = parseFloat(localStorage.getItem(userName))
                // newAmount = userScore + current;
                // /* the new amount is the previously logged amount + the newly entered amount */
                // userData = localStorage.setItem(userName, newAmount);
                // /* save the new amount under the key of the contract address */
                // console.log(newAmount);
                // alert("Please copy the following message and securely send it to the receiver: \nTotal amount owed to address " + userName + " is " + newAmount + " (signature: " + senderSignature + ")");
                // return false;
            });

        });




        // function logPayment() {
        //     //enter signature code here
        //     signPayment(
        //         contractAddress,
        //         document.getElementById("score").value,
        //         function (error, signature) {
        //             console.log("Contract: ", contractAddress);

        //             if (error) {
        //                 console.error(error);
        //             }
        //             else {
        //                 console.log("Signature: ", signature);
        //             }
        //         }
        //     );
        //     // const receiverInput = document.getElementById("receiver");
        //     // const receiverAddress = receiverInput.value;
        //     // const amount = document.getElementById("score").value;
        //     // console.log(receiverAddress);

        //     // let senderSignature = signPayment(receiverAddress, amount, nonce, contractAddress);

        //     //end signature code
        //     let userName = document.getElementById("name").value;
        //     let userScore = parseFloat(document.getElementById("score").value);

        //     const current = parseFloat(localStorage.getItem(userName))
        //     newAmount = userScore + current;
        //     /* the new amount is the previously logged amount + the newly entered amount */
        //     userData = localStorage.setItem(userName, newAmount);
        //     /* save the new amount under the key of the contract address */
        //     console.log(newAmount);
        //     alert("Please copy the following message and securely send it to the receiver: \nTotal amount owed to address " + userName + " is " + newAmount + " (signature: " + senderSignature + ")");
        //     return false;
        // }
    </script>
</body>



<!-- Close Channel -->
<!-- total amount due is calculated and stored in the variable totalDue - Medha -->
<!--PENDING: transfer totalDue from sender to receiver using smart contract. -->

<h3>Close Channel</h3>
<p>Closing the channel will add up all the logs and send the total amount owed to the receiver.
    Please note that this is irreversible.
<p>


    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Getting User Input</title>
    </head>

    <body>
        <!-- <form onsubmit="return closeChannel()">
            <label for="currentAddress">Contract Address:</label>
            <input type="text" id="currentAddress" required>

            <button type="submit">Close Channel</button>
        </form> -->

        <!-- <script>
            function closeChannel() {
                let currentAddress = document.getElementById("currentAddress").value;
                //console.log(localStorage.getItem(currentAddress));
                const totalDue = parseFloat(localStorage.getItem(currentAddress));
                console.log(totalDue);
                alert("The channel at address " + currentAddress + " is being closed. " + totalDue + " ETH will be transferred to the receiver.");
                return false;
            }
        </script> -->
    </body>



    </div>




    <!-- localStorage simple example
    <script>
        const name = "medha"
        localStorage.setItem('name', name);
        const userData =localStorage.getItem('name');
        console.log(userData);

    </script>
    -->





    <!-- <script src="script.js"></script> -->






</html>