<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Transfer Interface</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h2>Ethereum Transfer</h2>


        <!-- Login With MetaMask-->
        <h3>Log In</h3>

        <button id="loginButton">MetaMask Login</button>
        <p id="errorMessage" style="color: rgb(208, 21, 0); display: none;"></p>
        <script>

            document.addEventListener("DOMContentLoaded", function () {
                const loginButton = document.getElementById("loginButton");
                const errorMessage = document.getElementById("errorMessage");

                loginButton.addEventListener("click", async function () {
                    if (window.ethereum) {
                        try {
                            // Check if MetaMask is installed and the user is logged in
                            if (window.ethereum.selectedAddress) {
                                errorMessage.innerText = "You are already logged in with MetaMask.";
                                errorMessage.style.display = "block";
                                // You can perform further actions here if the user is already logged in
                            } else {
                                // Request account access if needed
                                // await window.ethereum.request({ method: "eth_requestAccounts" });
                                alert("MetaMask account already connected.");
                                // You can perform further actions after successful login here
                            }
                        } catch (error) {
                            errorMessage.innerText = "Error connecting MetaMask account: " + error.message;
                            errorMessage.style.display = "block";
                            console.error("Error connecting MetaMask account:", error);
                        }
                    } else {
                        alert("MetaMask extension not detected.");
                        // errorMessage.innerText = "MetaMask extension not detected";
                        // errorMessage.style.display = "block";
                        console.error("MetaMask extension not detected");
                    }
                });
            });

        </script>



        <!-- <script>
            document.addEventListener("DOMContentLoaded", function () {
                const loginButton = document.getElementById("loginButton");

                loginButton.addEventListener("click", async function () {
                    if (window.ethereum) {
                        try {
                            // Request account access if needed
                            await window.ethereum.request({ method: "eth_requestAccounts" });
                            console.log("MetaMask account connected");
                            // You can perform further actions after successful login here
                        } catch (error) {
                            console.error("Error connecting MetaMask account:", error);
                        }
                    } else {
                        console.error("MetaMask extension not detected");
                    }
                });
            });
        </script> -->

        <!-- Deploy New Channel -->
        <!-- THIS NEEDS TO BE IMPLEMENTED-->

        <h3>Create New Channel</h3>
        <p>To open a payment channel with a new receiver, fill out the fields below. If you already have a channel with
            this receiver, go to "Log Payments on an Existing Channel" and enter the Contract address for that existing
            channel.</p>

        <label for="sender">Sender Wallet Address:</label>
        <input type="text" id="sender" required>

        <label for="receiver">Receiver Wallet Address:</label>
        <input type="text" id="receiver" required>
        <p> After deploying the contract, please store the contract address. You will need to enter this address below
            to log future payments.</p>

        <button id="deployContractButton" onclick="document.location='default.asp'">Deploy Contract</button>

        <!-- Log a New Channel-->
        <!-- completed - Medha :) -->
        <h3>Log a New Channel</h3>
        <p> Enter the details of your newly created payment channel.</p>

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Getting User Input</title>
        </head>

        <body>
            <form onsubmit="return createNew()">
                <label for="newAddress">New Contract Address:</label>
                <input type="text" id="newAddress" required>

                <button type="submit">Submit</button>
            </form>

            <script>
                function createNew() {
                    let newAddress = document.getElementById("newAddress").value;

                    localStorage.setItem(newAddress, 0);
                    console.log(newAddress);
                    alert("New channel has been logged with the following address: " + newAddress);
                    return false;
                }
            </script>
        </body>


        <!-- Log Payments on Existing Channel -->
        <!-- completed - Medha :) -->
        <h3>Log Payments on Existing Channel</h3>

        <p> Please keep in mind that logging a payment is <i>not</i> equivalent to making an Ethereum transfer. The
            receiver will not receive any funds until the payment channel is closed, at which point the transfer will be
            made. </p>

</body>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting User Input</title>
</head>

<body>
    <form onsubmit="return logPayment()">
        <label for="name">Contract Address:</label>
        <input type="text" id="name" required>

        <label for="score">Amount (ETH):</label>
        <input type="text" id="score" required>

        <button type="submit">Log Payment</button>
    </form>

    <script>
        function logPayment() {
            let userName = document.getElementById("name").value;
            let userScore = parseFloat(document.getElementById("score").value);

            const current = parseFloat(localStorage.getItem(userName))
            //when a new channel is created, it is stored with a value of 0
            newAmount = userScore + current;
            /* the new amount is the previously logged amount + the newly entered amount */
            userData = localStorage.setItem(userName, newAmount);
            /* save the new amount under the key of the contract address */
            console.log(newAmount);
            alert("Total amount owed to address " + userName + " is " + newAmount + ".");
            return false;
        }
    </script>
</body>



<!-- Close Channel -->
<!-- total amount due is calculated and stored in the variable totalDue - Medha -->
<!--PENDING: transfer totalDue from sender to receiver using smart contract. -->

<h3>Close Channel</h3>
<label for="sendButton">Closing the channel will add up all the logs and send the total amount owed to the receiver.
    Please note that this is irreversible.</label>


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting User Input</title>
</head>

<body>
    <form onsubmit="return closeChannel()">
        <label for="currentAddress">Contract Address:</label>
        <input type="text" id="currentAddress" required>

        <button type="submit">Close Channel</button>
    </form>

    <script>
        function closeChannel() {
            let currentAddress = document.getElementById("currentAddress").value;
            //console.log(localStorage.getItem(currentAddress));
            const totalDue = parseFloat(localStorage.getItem(currentAddress));
            console.log(totalDue);
            alert("The channel at address " + currentAddress + " is being closed. " + totalDue + " ETH will be transferred to the receiver.");
            return false;
        }
    </script>
</body>


</div>




<!-- localStorage simple example
    <script>
        const name = "medha"
        localStorage.setItem('name', name);
        const userData =localStorage.getItem('name');
        console.log(userData);

    </script>
    -->





<!-- <script src="script.js"></script> -->






</html>